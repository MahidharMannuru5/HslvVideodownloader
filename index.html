<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HLS Player â€¢ Secure Playback</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; padding:20px; }
    .wrap { max-width: 980px; margin: 0 auto; display: grid; gap: 14px; }
    .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    input[type=url] { flex: 1 1 380px; padding:10px; border-radius:10px; border:1px solid #8884; }
    label { font-size:.95rem; }
    button { padding:10px 14px; border:0; border-radius:12px; cursor:pointer; }
    button.primary { background:#2563eb; color:#fff; }
    video { width:100%; aspect-ratio:16/9; background:#000; border-radius:16px; }
    .muted { opacity:.75; }
    #log { white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0000000a; padding:12px; border-radius:12px; max-height:240px; overflow:auto; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>HLS Player (Token/Headers Only)</h1>

    <div class="row">
      <input id="m3u8" type="url" placeholder="Paste your .m3u8 URL" />
      <button id="play" class="primary">Play</button>
    </div>

    <video id="video" controls playsinline></video>

    <details>
      <summary>Diagnostics</summary>
      <div id="log"></div>
    </details>
  </div>

  <!-- hls.js for playback -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>

  <script>
  const $ = s => document.querySelector(s);
  const video = $("#video");
  const urlInput = $("#m3u8");
  const playBtn  = $("#play");
  const logEl    = $("#log");

  let hls = null;

  function log(...args) {
    const t = new Date().toISOString().slice(11, 19);
    logEl.textContent += `[${t}] ${args.join(' ')}\n`;
    logEl.scrollTop = logEl.scrollHeight;
    console.log(...args);
  }

  async function setupHlsAndPlay(src) {
    if (!src) return alert('Paste a .m3u8 URL');
    video.crossOrigin = 'anonymous'; // CORS headers must be set server-side

    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    if (hls) { try { hls.destroy(); } catch{} hls = null; }

    if (Hls.isSupported()) {
      hls = new Hls({
        debug: true,
        enableWorker: true,
        xhrSetup: (xhr, url) => {
          xhr.withCredentials = false; // no cookies
        },
        fetchSetup: (ctx, init) => {
          return Object.assign(init || {}, {
            credentials: 'omit', // no cookies
            headers: {
              ...(init?.headers || {}),
              // 'Authorization': 'Bearer YOUR_TOKEN_HERE', // optional
            }
          });
        }
      });

      hls.attachMedia(video);
      hls.on(Hls.Events.MEDIA_ATTACHED, () => {
        hls.loadSource(src);
      });
      hls.on(Hls.Events.MANIFEST_PARSED, () => {
        video.play().catch(() => {});
        log('Manifest parsed');
      });
      hls.on(Hls.Events.ERROR, (_, data) => {
        log('hls.js error:', data?.details || data?.type || 'unknown');
        if (data?.fatal && isSafari) {
          try { hls.destroy(); } catch{} hls = null;
          video.src = src;
          video.play().catch(() => {});
          log('Falling back to native HLS');
        }
      });
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
      video.src = src;
      video.addEventListener('loadedmetadata', () => {
        video.play();
        log('Native HLS playback started');
      });
    } else {
      log('HLS not supported in this browser');
    }
  }

  playBtn.addEventListener('click', () => {
    const src = urlInput.value.trim();
    setupHlsAndPlay(src);
  });
  </script>
</body>
</html>
