<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HLS Player with Cookie Auth</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin:0; padding:20px; }
    .wrap { max-width: 920px; margin: 0 auto; display: grid; gap: 14px; }
    .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    input[type=url], input[type=text] { flex: 1 1 380px; padding:10px; border-radius:10px; border:1px solid #8884; }
    label { font-size:.95rem; }
    button { padding:10px 14px; border:0; border-radius:12px; cursor:pointer; }
    button.primary { background:#2563eb; color:#fff; }
    button.ghost { background:transparent; border:1px solid #8884; }
    video { width:100%; aspect-ratio:16/9; background:#000; border-radius:16px; }
    .muted { opacity:.75; }
    #log { white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#0000000a; padding:12px; border-radius:12px; max-height:240px; overflow:auto; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>HLS Player (sends your cookie)</h1>

    <div class="row">
      <input id="m3u8" type="url" placeholder="Paste your .m3u8 URL" />
      <button id="play" class="primary">Play</button>
    </div>

    <div class="row">
      <input id="cookieName"  type="text" placeholder="Cookie name (e.g., sessionid)" />
      <input id="cookieValue" type="text" placeholder="Cookie value" />
      <button id="setCookie" class="ghost">Set Cookie</button>
      <span class="muted">Cookie set for <span id="cookieScope"></span>. hls.js will send credentials.</span>
    </div>

    <video id="video" controls playsinline></video>

    <details>
      <summary>Diagnostics</summary>
      <div id="log"></div>
    </details>
  </div>

  <!-- hls.js for playback -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8/dist/hls.min.js"></script>

  <script>
  const $ = s => document.querySelector(s);
  const video = $("#video");
  const urlInput = $("#m3u8");
  const playBtn  = $("#play");
  const setBtn   = $("#setCookie");
  const nameEl   = $("#cookieName");
  const valueEl  = $("#cookieValue");
  const scopeEl  = $("#cookieScope");
  const logEl    = $("#log");

  let hls = null;

  function log(...a){ const t=new Date().toISOString().slice(11,19); logEl.textContent += `[${t}] ${a.join(' ')}\n`; logEl.scrollTop = logEl.scrollHeight; console.log(...a); }

  // --- Cookie: set for current origin (domain/path handled by browser) ---
  function setSiteCookie(name, value){
    // NOTE: You can only set cookies for the current site. If the HLS URL is on a different domain,
    // run through a same-origin proxy so the cookie applies.
    if (!name || !value) { alert('Cookie name and value are required'); return; }
    const secure = (location.protocol === 'https:');
    // Lax works for same-site. If you are truly cross-site via a proxy, this still works since requests are same-origin.
    document.cookie = `${encodeURIComponent(name)}=${encodeURIComponent(value)}; Path=/; ${secure ? 'Secure; ' : ''}SameSite=Lax`;
    scopeEl.textContent = location.host;
    log('Cookie set for', location.host);
  }

  setBtn.addEventListener('click', () => setSiteCookie(nameEl.value.trim(), valueEl.value.trim()));

  // --- HLS setup that always includes credentials (cookies) ---
  async function setupHlsAndPlay(src){
    if (!src) return alert('Paste a .m3u8 URL');

    // Ensure the <video> participates in credentialed fetches when relevant
    video.crossOrigin = 'use-credentials';

    // Prefer hls.js so we can force credentials. We will only fall back to native on Safari if needed.
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);

    if (hls) { try { hls.destroy(); } catch{} hls = null; }
    hls = new Hls({
      enableWorker: true,
      // XHR path (some loaders use XHR)
      xhrSetup: (xhr, url) => {
        xhr.withCredentials = true; // send cookies
      },
      // fetch path (modern loader)
      fetchSetup: (ctx, init) => {
        return Object.assign(init || {}, { credentials: 'include' });
      }
    });

    hls.attachMedia(video);
    hls.on(Hls.Events.MEDIA_ATTACHED, () => { hls.loadSource(src); });
    hls.on(Hls.Events.MANIFEST_PARSED, () => { video.play().catch(()=>{}); log('Manifest parsed'); });

    hls.on(Hls.Events.ERROR, (_, data) => {
      log('hls.js error:', data?.details || data?.type || 'unknown');
      if (data?.fatal && isSafari) {
        // Try native HLS on Safari (native will also send same-site cookies automatically)
        try { hls.destroy(); } catch{}
        hls = null;
        log('Falling back to native HLS on Safari');
        video.src = src;
        video.play().catch(()=>{});
      }
    });
  }

  playBtn.addEventListener('click', () => {
    const src = urlInput.value.trim();
    setupHlsAndPlay(src);
  });
  </script>
</body>
</html>
